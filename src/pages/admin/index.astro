---
import { blogService } from "../../services/blogService";
import { authService } from "../../services/authService";
import { Eye, Pencil, Trash2 } from "lucide-react";
import Layout from "@/layouts/Layout.astro";

const isAuthenticated = await authService.isAuthenticated();
if (!isAuthenticated) {
  return Astro.redirect("/login/");
}

// Verificar si hay mensajes de éxito en la URL
const deleted = Astro.url.searchParams.get("deleted");
const updated = Astro.url.searchParams.get("updated");
const created = Astro.url.searchParams.get("created");

// Obtener todos los blogs para mostrar en el panel
const blogs = await blogService.getAll();

/**
 * Elimina etiquetas HTML del contenido
 * @param html Contenido HTML a limpiar
 * @returns Texto plano sin etiquetas HTML
 */
function stripHtmlTags(html: string | null | undefined): string {
  if (!html) return "";
  return html.replace(/<[^>]*>/g, "");
}
---

<Layout title="Panel de Administración" headerTransparent={false}>
  <section class="px-8 mx-auto max-w-7xl mt-40">
    {
      deleted && (
        <div class="bg-stone-100 text-stone-700 px-4 py-4 mb-4 flex items-center gap-2 text-base">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z"
              clip-rule="evenodd"
            />
          </svg>
          El articulo se eliminó exitosamente.
        </div>
      )
    }
    {
      updated && (
        <div class="bg-stone-100 text-stone-700 px-4 py-4 mb-4 flex items-center gap-2 text-base">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z"
              clip-rule="evenodd"
            />
          </svg>
          El articulo se actualizó exitosamente.
        </div>
      )
    }
    {
      created && (
        <div class="bg-stone-100 text-stone-700 px-4 py-4 mb-4 flex items-center gap-2 text-base">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
            class="size-6"
          >
            <path
              fill-rule="evenodd"
              d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z"
              clip-rule="evenodd"
            />
          </svg>
          Los articulos se crearon exitosamente.
        </div>
      )
    }
  </section>

  <section class="px-8 mx-auto max-w-7xl">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-stone-900 font-secondary">
        Panel de Administración
      </h1>
      <a
        href="/admin/edit/new"
        class="bg-stone-600 hover:bg-stone-700 text-white px-8 py-4 text-sm font-medium rounded-full flex items-center gap-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 4.5v15m7.5-7.5h-15"></path>
        </svg>

        Nuevo artículo
      </a>
    </div>
  </section>

  <section class="px-8 mt-12 mx-auto max-w-7xl pb-24">
    {
      blogs.length === 0 ? (
        <div class="py-12 text-center">
          <h2 class="text-xl font-medium text-stone-600 mb-4">
            No hay blogs publicados aún
          </h2>
          <a
            href="/admin/edit/new"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2  text-sm font-medium"
          >
            Crear mi primer blog
          </a>
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {blogs.map((blog) => (
            <div class="bg-white -lg shadow-sm hover:shadow-md transition-shadow flex flex-col h-full">
              {blog["imagen destacada"] && (
                <div class="aspect-video w-full overflow-hidden -t-lg">
                  <img
                    src={blog["imagen destacada"]}
                    alt={blog.title || "Imagen del blog"}
                    class="h-full w-full object-cover"
                  />
                </div>
              )}
              <div class=" flex-1 flex flex-col justify-between ">
                <div class="px-6 pt-6">
                  <h3 class="text-xl font-semibold text-stone-900 mb-2">
                    {blog.title}
                  </h3>
                  <p class="text-stone-600 line-clamp-2 mb-4">
                    {blog.description
                      ? stripHtmlTags(blog.description)
                      : blog.contenido
                        ? stripHtmlTags(blog.contenido.substring(0, 120))
                        : "Sin contenido"}
                    ...
                  </p>
                </div>

                <div>
                  <div class="flex justify-between items-center text-sm text-stone-500 mb-4 px-6">
                    {blog.author && <span>Por {blog.author}</span>}
                    <span>
                      {new Date(blog.created_at || "").toLocaleDateString()}
                    </span>
                  </div>

                  <div class="flex gap-2 border-t pt-4 px-6 pb-6 flex-col">
                    <div class="flex gap-2 w-full">
                      <a
                        href={`/blog/${blog.id}`}
                        class="flex items-center justify-center px-3 py-2 text-sm font-medium text-white bg-stone-500  hover:bg-stone-600 w-full rounded-full transition-all"
                      >
                        <Eye className="h-4 w-4 mr-1" />
                        Ver
                      </a>
                      <a
                        href={`/admin/edit/${blog.id}`}
                        class="flex items-center justify-center px-3 py-2 text-sm font-medium text-stone-700 bg-stone-100  hover:bg-stone-200 w-full rounded-full transition-all"
                      >
                        <Pencil className="h-4 w-4 mr-1" />
                        Editar
                      </a>
                    </div>
                    <button
                      onclick={`eliminarBlog(${blog.id})`}
                      class="flex items-center justify-center px-3 py-2 text-sm font-medium text-stone-700 bg-white  hover:bg-stone-50 rounded-full transition-all w-full"
                    >
                      <Trash2 className="h-4 w-4 mr-1" />
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )
    }
  </section>
</Layout>

<script is:inline>
  function eliminarBlog(blogId) {
    if (confirm("¿Estás seguro de que deseas eliminar este blog?")) {
      fetch("/api/blogs/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: blogId }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            window.location.href = "/admin?deleted=true";
          } else {
            throw new Error(data.error || "Error desconocido");
          }
        })
        .catch((error) => {
          console.error("Error al eliminar blog:", error);
          alert("Error al eliminar el blog: " + error.message);
        });
    }
  }

  if (
    window.location.search.includes("deleted=true") ||
    window.location.search.includes("updated=true")
  ) {
    window.history.replaceState({}, "", "/admin");
  }
</script>
